<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>WZ用印系统</title>
  <style>
    :root{--bg:#0b0f14;--panel:#0f1620;--line:#1b2a3a;--text:#eaf2ff;--muted:#9fb2c8;--neon:#39ff14;}
    body{margin:0;min-height:100vh;background:linear-gradient(180deg,#0b0f14,#05070a);color:var(--text);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial;}
    .wrap{max-width:1200px;margin:0 auto;padding:18px;}
    .top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .dot{width:12px;height:12px;border-radius:999px;background:var(--neon);box-shadow:0 0 18px rgba(57,255,20,.55);}
    h1{font-size:18px;margin:0;font-weight:800}
    .sub{color:var(--muted);font-size:12px;margin-top:6px}
    .btn{border:1px solid rgba(57,255,20,.55);background:#0e1720;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{box-shadow:0 0 0 3px rgba(57,255,20,.10)}
    .panel{margin-top:12px;border:1px solid var(--line);background:rgba(15,22,32,.92);border-radius:16px;padding:12px;}
    .hint{color:var(--muted);font-size:12px;line-height:1.6}
    .ok{color:#9fffa0}
    .err{color:#ffb3b3}
    .layout{display:grid;grid-template-columns:240px 1fr 280px;gap:12px;align-items:start}
    @media(max-width:1100px){.layout{grid-template-columns:1fr}}
    .pages{max-height:72vh;overflow:auto;padding-right:4px}
    .pageItem{border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:8px;cursor:pointer;background:#0b121a}
    .pageItem.active{border-color:rgba(57,255,20,.55)}
    .pageItem .t{font-weight:700}
    .pageItem .s{font-size:12px;color:var(--muted);margin-top:4px}
    .viewer{position:relative;display:flex;justify-content:center}
    canvas{background:#fff;border-radius:10px;max-width:100%;height:auto}
    .overlay{position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none}
    .seal{
      position:absolute;
      width:140px; /* 默认显示尺寸，用户可调 */
      opacity:.85;
      cursor:move;
      pointer-events:auto;
      user-select:none;
      -webkit-user-drag:none;
      filter: drop-shadow(0 0 8px rgba(57,255,20,.08));
    }
    input{border:1px solid var(--line);background:#0b121a;color:var(--text);padding:10px;border-radius:12px;outline:none;width:100%}
    label{color:var(--muted);font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > div{flex:1;min-width:120px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <h1>WZ用印系统</h1>
        <div class="sub">可视化拖拽盖章（本地处理，不上传文件）</div>
      </div>
    </div>
    <div class="row">
      <button class="btn" id="backBtn">返回系统入口</button>
    </div>
  </div>

  <div class="panel">
    <div class="row" style="align-items:flex-end">
      <div style="flex:2;min-width:260px">
        <label>选择 PDF（≤10MB）</label><br/>
        <input id="pdfFile" type="file" accept="application/pdf"/>
      </div>
      <div style="flex:1;min-width:200px">
        <label>印章文件</label><br/>
        <div class="hint"><span class="mono">assets/wz.png</span>（透明 PNG）</div>
      </div>
    </div>
    <div id="msg" class="hint" style="margin-top:8px"></div>
  </div>

  <div class="layout" style="margin-top:12px">
    <!-- left: pages -->
    <div class="panel">
      <div class="hint" style="margin-bottom:8px">页列表（点击切换）</div>
      <div id="pages" class="pages"></div>
    </div>

    <!-- center: viewer -->
    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <div class="hint" id="pageTitle">未加载 PDF</div>
        <div class="row" style="gap:8px">
          <button class="btn" id="clearBtn">清除本页盖章</button>
        </div>
      </div>

      <div class="viewer" style="margin-top:10px">
        <canvas id="pdfCanvas"></canvas>
        <div class="overlay" id="overlay">
          <img id="sealEl" class="seal" src="./assets/wz.png" alt="seal" style="display:none"/>
        </div>
      </div>

      <div class="hint" style="margin-top:10px">
        拖动印章到位置即可（每页单独保存）。需要盖多页就切换页后继续拖。
      </div>
    </div>

    <!-- right: controls -->
    <div class="panel">
      <div class="hint" style="margin-bottom:8px">印章参数（当前页）</div>

      <div class="row">
        <div>
          <label>印章显示宽度（px，影响预览+导出）</label>
          <input id="sealPx" type="number" min="40" step="10" value="140"/>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>透明度（0~1）</label>
          <input id="opacity" type="number" min="0" max="1" step="0.05" value="0.85"/>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn" id="genBtn" style="width:100%">生成盖章 PDF 并下载</button>
      </div>

      <div class="hint" style="margin-top:10px">
        说明：PDF 合成在浏览器本地完成；不会上传服务器；导出为一个新 PDF。
      </div>
    </div>
  </div>
</div>

<!-- pdf.js (render preview) -->
<script src="https://unpkg.com/pdfjs-dist@4.6.82/build/pdf.min.js"></script>
<script>
  // pdf.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://unpkg.com/pdfjs-dist@4.6.82/build/pdf.worker.min.js";
</script>

<!-- pdf-lib (write stamp into PDF) -->
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

<script>
  const $ = (id)=>document.getElementById(id);
  const msgEl = $("msg");
  const pagesEl = $("pages");
  const canvas = $("pdfCanvas");
  const ctx = canvas.getContext("2d");
  const overlay = $("overlay");
  const sealEl = $("sealEl");

  $("backBtn").onclick = ()=> location.href = "https://szdblc.cn";

  function setMsg(text, type="") {
    msgEl.textContent = text;
    msgEl.className = "hint " + (type==="ok" ? "ok" : type==="err" ? "err" : "");
  }

  let pdfDocJS = null;         // pdf.js doc
  let pdfBytes = null;         // original bytes
  let pageCount = 0;
  let currentPage = 1;

  // per-page stamp state:
  // stamps[pageNo] = { xPx, yPx, wPx, opacity }   // x/y are in canvas pixels from top-left
  const stamps = {};

  // current render scale and viewport
  let renderScale = 1;
  let viewportW = 0;
  let viewportH = 0;

  // Load seal (ensure available)
  sealEl.onerror = ()=> setMsg("印章图片加载失败：请确认仓库存在 assets/wz.png", "err");

  // Upload PDF
  $("pdfFile").addEventListener("change", async () => {
    try {
      const file = $("pdfFile").files[0];
      if (!file) return;
      if (file.size > 10 * 1024 * 1024) return setMsg("PDF 超过 10MB，请换小一点的文件", "err");

      setMsg("正在加载 PDF…");
      pdfBytes = new Uint8Array(await file.arrayBuffer());
      pdfDocJS = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
      pageCount = pdfDocJS.numPages;

      // reset state
      for (const k of Object.keys(stamps)) delete stamps[k];
      currentPage = 1;

      buildPageList();
      await renderPage(1);

      setMsg(`已加载：${file.name}（共 ${pageCount} 页）`, "ok");
    } catch (e) {
      console.error(e);
      setMsg("加载失败：" + (e?.message || e), "err");
    }
  });

  function buildPageList() {
    pagesEl.innerHTML = "";
    for (let i=1;i<=pageCount;i++){
      const div = document.createElement("div");
      div.className = "pageItem" + (i===currentPage ? " active" : "");
      div.innerHTML = `<div class="t">第 ${i} 页</div>
        <div class="s">${stamps[i] ? "已设置盖章位置" : "未盖章"}</div>`;
      div.onclick = async ()=> {
        currentPage = i;
        highlightPageList();
        await renderPage(i);
      };
      pagesEl.appendChild(div);
    }
  }
  function highlightPageList() {
    [...pagesEl.children].forEach((c, idx)=>{
      c.classList.toggle("active", idx+1===currentPage);
      const s = c.querySelector(".s");
      if (s) s.textContent = stamps[idx+1] ? "已设置盖章位置" : "未盖章";
    });
  }

  async function renderPage(pageNo) {
    const page = await pdfDocJS.getPage(pageNo);

    // scale to fit container width (up to ~900px)
    const containerMax = Math.min(900, overlay.parentElement.clientWidth - 24);
    const unscaled = page.getViewport({ scale: 1 });
    renderScale = containerMax / unscaled.width;

    const viewport = page.getViewport({ scale: renderScale });
    viewportW = Math.floor(viewport.width);
    viewportH = Math.floor(viewport.height);

    canvas.width = viewportW;
    canvas.height = viewportH;

    // overlay should match canvas
    overlay.style.width = viewportW + "px";
    overlay.style.height = viewportH + "px";

    await page.render({ canvasContext: ctx, viewport }).promise;

    $("pageTitle").textContent = `当前：第 ${pageNo} 页（拖拽印章进行定位）`;

    // apply UI settings
    applySealStyleFromInputs();

    // place or hide seal for this page
    const st = stamps[pageNo];
    if (st) {
      showSealAt(st.xPx, st.yPx, st.wPx, st.opacity);
    } else {
      // default: center-ish
      const wPx = parseInt($("sealPx").value || "140", 10);
      const x = Math.max(0, Math.round((viewportW - wPx) * 0.75));
      const y = Math.max(0, Math.round((viewportH - wPx) * 0.75));
      showSealAt(x, y, wPx, parseFloat($("opacity").value || "0.85"));
      // BUT do not commit until user drags or changes settings
      // keep as "preview only"
      delete stamps[pageNo];
      highlightPageList();
    }
  }

  function applySealStyleFromInputs() {
    const wPx = parseInt($("sealPx").value || "140", 10);
    const opacity = Math.max(0, Math.min(1, parseFloat($("opacity").value || "0.85")));
    sealEl.style.width = wPx + "px";
    sealEl.style.opacity = String(opacity);
  }

  function showSealAt(xPx, yPx, wPx, opacity) {
    sealEl.style.display = "block";
    sealEl.style.left = xPx + "px";
    sealEl.style.top = yPx + "px";
    sealEl.style.width = wPx + "px";
    sealEl.style.opacity = String(opacity);
  }

  // When user changes inputs, update current page stamp + preview
  $("sealPx").addEventListener("input", ()=> {
    applySealStyleFromInputs();
    commitCurrentStampFromDOM();
  });
  $("opacity").addEventListener("input", ()=> {
    applySealStyleFromInputs();
    commitCurrentStampFromDOM();
  });

  function commitCurrentStampFromDOM() {
    if (sealEl.style.display === "none") return;
    const xPx = parseFloat(sealEl.style.left || "0");
    const yPx = parseFloat(sealEl.style.top || "0");
    const wPx = parseFloat(sealEl.style.width || "140");
    const opacity = parseFloat(sealEl.style.opacity || "0.85");
    stamps[currentPage] = { xPx, yPx, wPx, opacity };
    highlightPageList();
  }

  // Drag logic
  let dragging = false;
  let dragOffsetX = 0;
  let dragOffsetY = 0;

  sealEl.addEventListener("pointerdown", (e)=>{
    dragging = true;
    sealEl.setPointerCapture(e.pointerId);
    const rect = sealEl.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;
    e.preventDefault();
  });

  sealEl.addEventListener("pointermove", (e)=>{
    if (!dragging) return;
    const ov = overlay.getBoundingClientRect();
    let x = e.clientX - ov.left - dragOffsetX;
    let y = e.clientY - ov.top - dragOffsetY;

    // clamp within overlay
    const w = parseFloat(sealEl.style.width || "140");
    const h = w; // approx; we keep square in preview, actual ratio applied in PDF embedding
    x = Math.max(0, Math.min(viewportW - w, x));
    y = Math.max(0, Math.min(viewportH - h, y));

    sealEl.style.left = Math.round(x) + "px";
    sealEl.style.top = Math.round(y) + "px";
    commitCurrentStampFromDOM();
    e.preventDefault();
  });

  sealEl.addEventListener("pointerup", (e)=>{
    dragging = false;
    try { sealEl.releasePointerCapture(e.pointerId); } catch {}
    e.preventDefault();
  });

  // Clear current page stamp
  $("clearBtn").onclick = ()=> {
    delete stamps[currentPage];
    sealEl.style.display = "none";
    highlightPageList();
    setMsg(`已清除：第 ${currentPage} 页盖章设置`, "ok");
  };

  // Generate stamped PDF
  $("genBtn").onclick = async ()=> {
    try {
      if (!pdfBytes) return setMsg("请先上传 PDF", "err");
      const keys = Object.keys(stamps);
      if (keys.length === 0) return setMsg("你还没有在任何页面设置盖章位置", "err");

      setMsg("正在生成盖章 PDF…（页数多时可能需要几秒）");

      // Load seal bytes
      const sealResp = await fetch("./assets/wz.png", { cache: "no-store" });
      if (!sealResp.ok) throw new Error("读取印章失败：assets/wz.png");
      const sealBytes = new Uint8Array(await sealResp.arrayBuffer());

      const { PDFDocument } = PDFLib;
      const pdfDoc = await PDFDocument.load(pdfBytes);
      const png = await pdfDoc.embedPng(sealBytes);

      // For each stamped page, map canvas px -> PDF points
      for (const pStr of keys) {
        const pNo = parseInt(pStr, 10);
        const st = stamps[pNo];
        if (!st) continue;

        const page = pdfDoc.getPages()[pNo - 1];
        const pw = page.getWidth();
        const ph = page.getHeight();

        // px -> point scale
        // We rendered using pdf.js viewport (renderScale). Canvas width corresponds to PDF width * renderScale.
        // So 1px in canvas = 1/renderScale points (approximately)
        const ptPerPx = 1 / renderScale;

        const xPt = st.xPx * ptPerPx;

        // NOTE: canvas y is from top; PDF y is from bottom
        const yFromTopPt = st.yPx * ptPerPx;

        // seal width in points
        const wPt = st.wPx * ptPerPx;
        const hPt = wPt * (png.height / png.width);

        // convert y
        const yPt = ph - yFromTopPt - hPt;

        page.drawImage(png, { x: xPt, y: yPt, width: wPt, height: hPt, opacity: st.opacity });
      }

      const out = await pdfDoc.save();
      const blob = new Blob([out], { type: "application/pdf" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `WZ盖章-${new Date().toISOString().slice(0,10)}.pdf`;
      a.click();
      URL.revokeObjectURL(a.href);

      setMsg("生成成功，已下载。", "ok");
    } catch (e) {
      console.error(e);
      setMsg("生成失败：" + (e?.message || e), "err");
    }
  };
</script>
</body>
</html>

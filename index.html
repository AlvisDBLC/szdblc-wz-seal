<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>WZ用印系统</title>
  <style>
    :root{--bg:#0b0f14;--panel:#0f1620;--line:#1b2a3a;--text:#eaf2ff;--muted:#9fb2c8;--neon:#39ff14;}
    *{box-sizing:border-box;}
    body{
      margin:0;min-height:100vh;
      background:linear-gradient(180deg,#0b0f14,#05070a);
      color:var(--text);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px;}
    .top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .dot{width:12px;height:12px;border-radius:999px;background:var(--neon);box-shadow:0 0 18px rgba(57,255,20,.55);}
    h1{font-size:18px;margin:0;font-weight:800}
    .sub{color:var(--muted);font-size:12px;margin-top:6px}
    .btn{border:1px solid rgba(57,255,20,.55);background:#0e1720;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{box-shadow:0 0 0 3px rgba(57,255,20,.10)}
    .panel{margin-top:12px;border:1px solid var(--line);background:rgba(15,22,32,.92);border-radius:16px;padding:12px;}
    .hint{color:var(--muted);font-size:12px;line-height:1.6}
    .ok{color:#9fffa0}
    .err{color:#ffb3b3}
    .layout{display:grid;grid-template-columns:240px 1fr 280px;gap:12px;align-items:start}
    @media(max-width:1100px){.layout{grid-template-columns:1fr}}
    .pages{max-height:72vh;overflow:auto;padding-right:4px}
    .pageItem{border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:8px;cursor:pointer;background:#0b121a}
    .pageItem.active{border-color:rgba(57,255,20,.55)}
    .pageItem .t{font-weight:700}
    .pageItem .s{font-size:12px;color:var(--muted);margin-top:4px}
    .viewer{position:relative;display:flex;justify-content:center}
    canvas{background:#fff;border-radius:10px;max-width:100%;height:auto}
    .overlay{position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none}
    .seal{
      position:absolute;
      width:140px;
      opacity:.85;
      cursor:move;
      pointer-events:auto;
      user-select:none;
      -webkit-user-drag:none;
      filter: drop-shadow(0 0 8px rgba(57,255,20,.08));
    }
    input{
      border:1px solid var(--line);
      background:#0b121a;
      color:var(--text);
      padding:10px;
      border-radius:12px;
      outline:none;
      width:100%;
      max-width:100%;
      min-width:0;
    }
    label{color:var(--muted);font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > div{flex:1;min-width:0}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <h1>WZ用印系统</h1>
        <div class="sub">可视化拖拽盖章（本地处理，不上传文件）</div>
      </div>
    </div>
    <button class="btn" id="backBtn">返回系统入口</button>
  </div>

  <div class="panel">
    <div class="row" style="align-items:flex-end">
      <div style="flex:2;min-width:260px">
        <label>选择 PDF（≤10MB）</label><br/>
        <input id="pdfFile" type="file" accept="application/pdf"/>
      </div>
      <div style="flex:1;min-width:200px">
        <div class="hint">印章已内置（不显示路径）</div>
      </div>
    </div>
    <div id="msg" class="hint" style="margin-top:8px"></div>
  </div>

  <div class="layout" style="margin-top:12px">
    <div class="panel">
      <div class="hint" style="margin-bottom:8px">页列表（点击切换）</div>
      <div id="pages" class="pages"></div>
    </div>

    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <div class="hint" id="pageTitle">未加载 PDF</div>
        <button class="btn" id="clearBtn">清除本页盖章</button>
      </div>

      <div class="viewer" style="margin-top:10px">
        <canvas id="pdfCanvas"></canvas>
        <div class="overlay" id="overlay">
          <img id="sealEl" class="seal" src="./assets/wz.png" alt="seal" style="display:none"/>
        </div>
      </div>

      <div class="hint" style="margin-top:10px">
        拖动印章到位置即可（每页单独保存）。
      </div>
    </div>

    <div class="panel">
      <div class="hint" style="margin-bottom:8px">印章参数（当前页）</div>

      <div class="row">
        <div>
          <label>印章显示宽度（px）</label>
          <input id="sealPx" type="number" min="40" step="10" value="140"/>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>透明度（0~1）</label>
          <input id="opacity" type="number" min="0" max="1" step="0.05" value="0.85"/>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn" id="genBtn" style="width:100%">生成盖章 PDF 并下载</button>
      </div>

      <div class="hint" style="margin-top:10px">
        PDF 合成在浏览器本地完成；不会上传服务器；导出为一个新 PDF。
      </div>
    </div>
  </div>
</div>

<!-- pdf.js (preview) - use stable 3.x for better compatibility -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script>
  // Guard: if CDN blocked, show message instead of crashing
  if (!window.pdfjsLib) {
    document.getElementById("msg").textContent =
      "加载失败：PDF 预览组件（pdf.js）未能加载。请检查网络是否拦截 jsdelivr。";
    document.getElementById("msg").className = "hint err";
  } else {
    window.pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
  }
  function normalizePdfBytes(u8) {
  // pdf-lib 对头部更严格：必须从 %PDF- 开始
  const header = [0x25,0x50,0x44,0x46,0x2D]; // "%PDF-"
  const maxScan = Math.min(u8.length - header.length, 4096); // 扫描前4KB足够
  for (let i = 0; i <= maxScan; i++) {
    let ok = true;
    for (let j = 0; j < header.length; j++) {
      if (u8[i + j] !== header[j]) { ok = false; break; }
    }
    if (ok) {
      return i === 0 ? u8 : u8.slice(i);
    }
  }
  // 找不到就原样返回，让错误信息继续提示
  return u8;
}

</script>

<!-- pdf-lib (write stamp) -->
<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

<script>
  const $ = (id)=>document.getElementById(id);
  const msgEl = $("msg");
  const pagesEl = $("pages");
  const canvas = $("pdfCanvas");
  const ctx = canvas.getContext("2d");
  const overlay = $("overlay");
  const sealEl = $("sealEl");

  $("backBtn").onclick = ()=> location.href = "https://szdblc.cn";

  function setMsg(text, type="") {
    msgEl.textContent = text;
    msgEl.className = "hint " + (type==="ok" ? "ok" : type==="err" ? "err" : "");
  }

  let pdfDocJS = null;
  let pdfBytes = null;
  let pageCount = 0;
  let currentPage = 1;

  const stamps = {}; // per-page

  let renderScale = 1;
  let viewportW = 0;
  let viewportH = 0;

  sealEl.onerror = ()=> setMsg("印章图片加载失败：请确认仓库存在 assets/wz.png", "err");

  $("pdfFile").addEventListener("change", async () => {
    try {
      if (!window.pdfjsLib) return; // already warned
      const file = $("pdfFile").files[0];
      if (!file) return;
      if (file.size > 10 * 1024 * 1024) return setMsg("PDF 超过 10MB，请换小一点的文件", "err");

      setMsg("正在加载 PDF…");
      const ab = await file.arrayBuffer();
      pdfBytes = new Uint8Array(ab);                     // 给 pdf-lib 用
      const pdfBytesForJs = new Uint8Array(ab.slice(0)); // 给 pdf.js 用（独立副本）
      pdfDocJS = await pdfjsLib.getDocument({ data: pdfBytesForJs }).promise;
      pageCount = pdfDocJS.numPages;

      for (const k of Object.keys(stamps)) delete stamps[k];
      currentPage = 1;

      buildPageList();
      await renderPage(1);

      setMsg(`已加载：${file.name}（共 ${pageCount} 页）`, "ok");
    } catch (e) {
      console.error(e);
      setMsg("加载失败：" + (e?.message || e), "err");
    }
  });

  function buildPageList() {
    pagesEl.innerHTML = "";
    for (let i=1;i<=pageCount;i++){
      const div = document.createElement("div");
      div.className = "pageItem" + (i===currentPage ? " active" : "");
      div.innerHTML = `<div class="t">第 ${i} 页</div><div class="s">${stamps[i] ? "已设置盖章位置" : "未盖章"}</div>`;
      div.onclick = async ()=> {
        currentPage = i;
        highlightPageList();
        await renderPage(i);
      };
      pagesEl.appendChild(div);
    }
  }
  function highlightPageList() {
    [...pagesEl.children].forEach((c, idx)=>{
      c.classList.toggle("active", idx+1===currentPage);
      const s = c.querySelector(".s");
      if (s) s.textContent = stamps[idx+1] ? "已设置盖章位置" : "未盖章";
    });
  }

  async function renderPage(pageNo) {
    const page = await pdfDocJS.getPage(pageNo);

    const containerMax = Math.min(900, overlay.parentElement.clientWidth - 24);
    const unscaled = page.getViewport({ scale: 1 });
    renderScale = containerMax / unscaled.width;

    const viewport = page.getViewport({ scale: renderScale });
    viewportW = Math.floor(viewport.width);
    viewportH = Math.floor(viewport.height);

    canvas.width = viewportW;
    canvas.height = viewportH;

    overlay.style.width = viewportW + "px";
    overlay.style.height = viewportH + "px";

    await page.render({ canvasContext: ctx, viewport }).promise;

    $("pageTitle").textContent = `当前：第 ${pageNo} 页（拖拽印章进行定位）`;

    applySealStyleFromInputs();

    const st = stamps[pageNo];
    if (st) {
      showSealAt(st.xPx, st.yPx, st.wPx, st.opacity);
    } else {
      sealEl.style.display = "none";
    }
  }

  function applySealStyleFromInputs() {
    const wPx = parseInt($("sealPx").value || "140", 10);
    const opacity = Math.max(0, Math.min(1, parseFloat($("opacity").value || "0.85")));
    sealEl.style.width = wPx + "px";
    sealEl.style.opacity = String(opacity);
  }

  function showSealAt(xPx, yPx, wPx, opacity) {
    sealEl.style.display = "block";
    sealEl.style.left = xPx + "px";
    sealEl.style.top = yPx + "px";
    sealEl.style.width = wPx + "px";
    sealEl.style.opacity = String(opacity);
  }

  $("sealPx").addEventListener("input", ()=> { applySealStyleFromInputs(); commitCurrentStampFromDOM(true); });
  $("opacity").addEventListener("input", ()=> { applySealStyleFromInputs(); commitCurrentStampFromDOM(true); });

  function commitCurrentStampFromDOM(keepIfHidden=false) {
    if (sealEl.style.display === "none" && !keepIfHidden) return;
    const xPx = parseFloat(sealEl.style.left || "0");
    const yPx = parseFloat(sealEl.style.top || "0");
    const wPx = parseFloat(sealEl.style.width || "140");
    const opacity = parseFloat(sealEl.style.opacity || "0.85");
    // only commit if visible
    if (sealEl.style.display !== "none") {
      stamps[currentPage] = { xPx, yPx, wPx, opacity };
      highlightPageList();
    }
  }

  // Drag
  let dragging = false;
  let dragOffsetX = 0;
  let dragOffsetY = 0;

  sealEl.addEventListener("pointerdown", (e)=>{
    dragging = true;
    sealEl.setPointerCapture(e.pointerId);
    const rect = sealEl.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;
    e.preventDefault();
  });

  sealEl.addEventListener("pointermove", (e)=>{
    if (!dragging) return;
    const ov = overlay.getBoundingClientRect();
    let x = e.clientX - ov.left - dragOffsetX;
    let y = e.clientY - ov.top - dragOffsetY;

    const w = parseFloat(sealEl.style.width || "140");
    const h = w; // preview clamp

    x = Math.max(0, Math.min(viewportW - w, x));
    y = Math.max(0, Math.min(viewportH - h, y));

    sealEl.style.left = Math.round(x) + "px";
    sealEl.style.top = Math.round(y) + "px";

    stamps[currentPage] = {
      xPx: parseFloat(sealEl.style.left),
      yPx: parseFloat(sealEl.style.top),
      wPx: w,
      opacity: parseFloat(sealEl.style.opacity || "0.85"),
    };
    highlightPageList();
    e.preventDefault();
  });

  sealEl.addEventListener("pointerup", (e)=>{
    dragging = false;
    try { sealEl.releasePointerCapture(e.pointerId); } catch {}
    e.preventDefault();
  });

  // Click on canvas area to place stamp if not shown yet
  canvas.addEventListener("click", (e)=>{
    if (!pdfBytes) return;
    const rect = canvas.getBoundingClientRect();
    const x = Math.max(0, Math.round((e.clientX - rect.left) * (canvas.width / rect.width)));
    const y = Math.max(0, Math.round((e.clientY - rect.top) * (canvas.height / rect.height)));
    const wPx = parseInt($("sealPx").value || "140", 10);
    const opacity = parseFloat($("opacity").value || "0.85");
    const clampedX = Math.max(0, Math.min(viewportW - wPx, x));
    const clampedY = Math.max(0, Math.min(viewportH - wPx, y));
    showSealAt(clampedX, clampedY, wPx, opacity);
    stamps[currentPage] = { xPx: clampedX, yPx: clampedY, wPx, opacity };
    highlightPageList();
  });

  $("clearBtn").onclick = ()=> {
    delete stamps[currentPage];
    sealEl.style.display = "none";
    highlightPageList();
    setMsg(`已清除：第 ${currentPage} 页盖章设置`, "ok");
  };

  $("genBtn").onclick = async ()=> {
    try {
      if (!pdfBytes) return setMsg("请先上传 PDF", "err");
      const keys = Object.keys(stamps);
      if (keys.length === 0) return setMsg("你还没有在任何页面设置盖章位置（点击页面放置或拖拽）", "err");

      setMsg("正在生成盖章 PDF…");

      const sealResp = await fetch("./assets/wz.png", { cache: "no-store" });
      if (!sealResp.ok) throw new Error("读取印章失败");
      const sealBytes = new Uint8Array(await sealResp.arrayBuffer());

      const { PDFDocument } = PDFLib;
      const fixedBytes = normalizePdfBytes(pdfBytes.slice(0)); // 做一次修正+拷贝
      const pdfDoc = await PDFDocument.load(fixedBytes);
      const png = await pdfDoc.embedPng(sealBytes);

      for (const pStr of keys) {
        const pNo = parseInt(pStr, 10);
        const st = stamps[pNo];
        if (!st) continue;

        const page = pdfDoc.getPages()[pNo - 1];
        const pw = page.getWidth();
        const ph = page.getHeight();

        const ptPerPx = 1 / renderScale;
        const xPt = st.xPx * ptPerPx;
        const yFromTopPt = st.yPx * ptPerPx;
        const wPt = st.wPx * ptPerPx;
        const hPt = wPt * (png.height / png.width);
        const yPt = ph - yFromTopPt - hPt;

        page.drawImage(png, { x: xPt, y: yPt, width: wPt, height: hPt, opacity: st.opacity });
      }

      const out = await pdfDoc.save();
      const blob = new Blob([out], { type: "application/pdf" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `WZ盖章-${new Date().toISOString().slice(0,10)}.pdf`;
      a.click();
      URL.revokeObjectURL(a.href);

      setMsg("生成成功，已下载。", "ok");
    } catch (e) {
      console.error(e);
      setMsg("生成失败：" + (e?.message || e), "err");
    }
  };
</script>
</body>
</html>
